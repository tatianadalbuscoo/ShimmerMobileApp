<!-- 
MainPage.xaml
Main user interface page for displaying and configuring available Shimmer devices.
Includes device selection, sensor options toggles, and a button to initiate connection and refresh.
-->

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ShimmerInterface.ViewModels"
             xmlns:models="clr-namespace:ShimmerInterface.Models"
             x:Class="ShimmerInterface.Views.MainPage"
             x:Name="MainPageRoot"
             BackgroundColor="{StaticResource PageBackground}">

    <ContentPage.BindingContext>
        <viewmodels:MainPageViewModel />
    </ContentPage.BindingContext>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="18" HorizontalOptions="Center" WidthRequest="380">

            <Label Text="Select Shimmer Device" Style="{StaticResource TitleLabel}" />

            <Button Text="Refresh Devices"
                    Style="{StaticResource SecondaryButton}"
                    Command="{Binding RefreshDevicesCommand}" />

            <CollectionView ItemsSource="{Binding AvailableDevices}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="15" Margin="5" BorderColor="Gray" BackgroundColor="White" CornerRadius="8">
                            <VerticalStackLayout Spacing="10">

                                <!-- Header: name + side badge IMU/EXG -->
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8">
                                    <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding DisplayName}"
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           TextColor="Black" />

                                    <Frame Grid.Row="0" Grid.Column="1"
                                       Padding="8,2"
                                       CornerRadius="10"
                                       HasShadow="False"
                                       BackgroundColor="White"
                                       BorderColor="Gray"
                                       VerticalOptions="Center">

                                        <!-- Mostra EXG/IMU o "device off" -->
                                        <Label Text="{Binding RightBadge}"
                                           FontAttributes="Bold"
                                           FontSize="12"
                                           TextColor="Black">
                                            <!-- Se "device off", colora il testo di rosso -->
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" Binding="{Binding RightBadge}" Value="device off">
                                                    <Setter Property="TextColor" Value="IndianRed" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>

                                        <!-- Se "device off", colora anche il bordo/background -->
                                        <Frame.Triggers>
                                            <DataTrigger TargetType="Frame" Binding="{Binding RightBadge}" Value="device off">
                                                <Setter Property="BorderColor" Value="IndianRed" />
                                                <Setter Property="BackgroundColor" Value="#FFF5F5" />
                                            </DataTrigger>
                                        </Frame.Triggers>
                                    </Frame>


                                    <Label Grid.Row="1" Grid.Column="0"
                                           Text="{Binding PortDisplay}"
                                           FontSize="12"
                                           TextColor="Gray" />
                                </Grid>

                                <!-- Select device -->
                                <HorizontalStackLayout Spacing="10"
                                                       Padding="0,6,0,10"
                                                       HeightRequest="44"
                                                       MinimumHeightRequest="44"
                                                       VerticalOptions="Center">
                                    <Switch IsToggled="{Binding IsSelected, Mode=TwoWay}"
                                            WidthRequest="52"
                                            HeightRequest="32"
                                            MinimumHeightRequest="32"
                                            HorizontalOptions="Start"
                                            VerticalOptions="Center" />
                                    <Label Text="Select for connection"
                                           VerticalOptions="Center"
                                           FontSize="14"
                                           TextColor="Black" />
                                </HorizontalStackLayout>

                                <!-- Separator -->
                                <BoxView HeightRequest="1"
                                         BackgroundColor="LightGray"
                                         Margin="0,20,0,0" />

                                <!-- Sensor configuration -->
                                <Label Text="Sensor Configuration"
                                       FontAttributes="Bold"
                                       FontSize="14"
                                       TextColor="Black" />

                                <!-- Toggles grid + EXG mode at the end -->
                                <Grid ColumnDefinitions="*,Auto"
                                      RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                                      RowSpacing="8">

                                    <Label Grid.Row="0" Grid.Column="0" Text="Low-Noise Accelerometer" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="0" Grid.Column="1" IsToggled="{Binding EnableLowNoiseAccelerometer, Mode=TwoWay}" />

                                    <Label Grid.Row="1" Grid.Column="0" Text="Wide-Range Accelerometer" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="1" Grid.Column="1" IsToggled="{Binding EnableWideRangeAccelerometer, Mode=TwoWay}" />

                                    <Label Grid.Row="2" Grid.Column="0" Text="Gyroscope" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="2" Grid.Column="1" IsToggled="{Binding EnableGyroscope, Mode=TwoWay}" />

                                    <Label Grid.Row="3" Grid.Column="0" Text="Magnetometer" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="3" Grid.Column="1" IsToggled="{Binding EnableMagnetometer, Mode=TwoWay}" />

                                    <Label Grid.Row="4" Grid.Column="0" Text="Pressure &amp; Temperature" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="4" Grid.Column="1" IsToggled="{Binding EnablePressureTemperature, Mode=TwoWay}" />

                                    <Label Grid.Row="5" Grid.Column="0" Text="Battery Voltage" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="5" Grid.Column="1" IsToggled="{Binding EnableBattery, Mode=TwoWay}" />

                                    <Label Grid.Row="6" Grid.Column="0" Text="External ADC A6" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="6" Grid.Column="1" IsToggled="{Binding EnableExtA6, Mode=TwoWay}" />

                                    <Label Grid.Row="7" Grid.Column="0" Text="External ADC A7" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="7" Grid.Column="1" IsToggled="{Binding EnableExtA7, Mode=TwoWay}" />

                                    <Label Grid.Row="8" Grid.Column="0" Text="External ADC A15" VerticalOptions="Center" TextColor="Black" />
                                    <Switch Grid.Row="8" Grid.Column="1" IsToggled="{Binding EnableExtA15, Mode=TwoWay}" />

                                    <!-- NEW: ECG/EMG (solo per EXG) -->
                                    <Label Grid.Row="9" Grid.Column="0"
                                           Text="ECG/EMG"
                                           VerticalOptions="Start"
                                           TextColor="Black"
                                           IsVisible="{Binding IsExg}"
                                           Margin="0,12,0,0" />

                                    <VerticalStackLayout Grid.Row="9" Grid.Column="1"
                                                         Spacing="6"
                                                         IsVisible="{Binding IsExg}"
                                                         Margin="0,12,0,0">
                                        <RadioButton Content="ECG"
                                                     GroupName="{Binding ExgModeGroupName}"
                                                     IsChecked="{Binding IsExgModeECG, Mode=TwoWay}" />
                                        <RadioButton Content="EMG"
                                                     GroupName="{Binding ExgModeGroupName}"
                                                     IsChecked="{Binding IsExgModeEMG, Mode=TwoWay}" />
                                        <RadioButton Content="EXG Test"
                                                     GroupName="{Binding ExgModeGroupName}"
                                                     IsChecked="{Binding IsExgModeTest, Mode=TwoWay}" />
                                        <RadioButton Content="Respiration"
                                                     GroupName="{Binding ExgModeGroupName}"
                                                     IsChecked="{Binding IsExgModeRespiration, Mode=TwoWay}" />
                                    </VerticalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                        </Frame>

                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Button Text="Connect to Selected Devices"
                    Style="{StaticResource PrimaryButton}"
                    Command="{Binding ConnectCommand}"
                    CommandParameter="{Binding Navigation, Source={x:Reference MainPageRoot}}" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
