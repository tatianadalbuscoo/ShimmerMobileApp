<!-- 
    
    MainPage.xaml
    Main user interface page for displaying and configuring available Shimmer devices.
    Includes device selection, sensor options toggles, and a button to initiate connection and refresh.
    Adds a Scan status badge next to the "Refresh Devices" button: shows "Scanning..." while refreshing and "Scan OK" / "Scan Failed" after the scan.

-->


<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:shapes="clr-namespace:Microsoft.Maui.Controls.Shapes;assembly=Microsoft.Maui.Controls"
             xmlns:viewmodels="clr-namespace:ShimmerInterface.ViewModels"
             xmlns:models="clr-namespace:ShimmerInterface.Models"
             x:Class="ShimmerInterface.Views.MainPage"
             x:Name="MainPageRoot"
             BackgroundColor="{StaticResource PageBackground}">

    <!-- Reusable template to render radio buttons as a stroked circle with a filled dot when checked -->
    <ContentPage.Resources>
        <ControlTemplate x:Key="RadioWithDotTemplate">
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                <Grid WidthRequest="18" HeightRequest="18" VerticalOptions="Center">
                    <shapes:Ellipse WidthRequest="18" HeightRequest="18"
                    Fill="Transparent" Stroke="Black" StrokeThickness="2" />
                    <shapes:Ellipse WidthRequest="10" HeightRequest="10"
                    Fill="Black"
                    HorizontalOptions="Center" VerticalOptions="Center"
                    IsVisible="{TemplateBinding IsChecked}" />
                </Grid>

                <!-- Presents the radio content (label) to the right of the dot -->
                <ContentPresenter Grid.Column="1" VerticalOptions="Center" />
            </Grid>
        </ControlTemplate>
    </ContentPage.Resources>


    <ContentPage.BindingContext>
        <viewmodels:MainPageViewModel />
    </ContentPage.BindingContext>

    <Grid>

        <!-- ScrollView ensures the whole content is scrollable on smaller screens -->
        <ScrollView>

            <!-- Fixed content width for a centered, compact layout -->
            <VerticalStackLayout Padding="20" Spacing="18" HorizontalOptions="Center" WidthRequest="380">

            <Label Text="Select Shimmer Device" Style="{StaticResource TitleLabel}" />

                <!-- Refresh button triggers device discovery.
                     DataTrigger disables the button while a refresh is in progress. -->
                <Button Text="Refresh Devices"
                    Style="{StaticResource SecondaryButton}"
                    Command="{Binding RefreshDevicesCommand}">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding IsRefreshing}" Value="True">
                                        <Setter Property="IsEnabled" Value="False" />
                                    </DataTrigger>
                                </Button.Triggers>
                 </Button>

                <!-- Device list. Each item is a device entry with selection and sensor toggles. -->
                <CollectionView ItemsSource="{Binding AvailableDevices}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        
                         <!-- Card-like container for each device -->
                            <Frame Padding="15" Margin="5" BorderColor="Gray" BackgroundColor="White" CornerRadius="8">
                                <VerticalStackLayout Spacing="10">

                                    <!-- Header row: device name + right-aligned badge (IMU/EXG or device off) + port info -->
                                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8">
                                        <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding DisplayName}"
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           TextColor="Black" />

                                        <!-- Badge shows EXG/IMU or "device off". -->
                                        <Frame Grid.Row="0" Grid.Column="1"
                                       Padding="8,2"
                                       CornerRadius="10"
                                       HasShadow="False"
                                       BackgroundColor="White"
                                       BorderColor="Gray"
                                       VerticalOptions="Center">

                                            <!-- Mostra EXG/IMU o "device off" -->
                                            <Label Text="{Binding RightBadge}"
                                           FontAttributes="Bold"
                                           FontSize="12"
                                           TextColor="Black">

                                                <!-- If "device off", tint text red -->
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" Binding="{Binding RightBadge}" Value="device off">
                                                        <Setter Property="TextColor" Value="IndianRed" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>

                                            <!-- If "device off", also tint badge frame -->
                                            <Frame.Triggers>
                                                <DataTrigger TargetType="Frame" Binding="{Binding RightBadge}" Value="device off">
                                                    <Setter Property="BorderColor" Value="IndianRed" />
                                                    <Setter Property="BackgroundColor" Value="#FFF5F5" />
                                                </DataTrigger>
                                            </Frame.Triggers>
                                        </Frame>

                                        <!-- Secondary line with port info (e.g., COMx / MAC) -->
                                        <Label Grid.Row="1" Grid.Column="0"
                                           Text="{Binding PortDisplay}"
                                           FontSize="12"
                                           TextColor="Gray" />
                                    </Grid>

                                    <!-- Device selection toggle for connecting -->
                                    <HorizontalStackLayout Spacing="10"
                                                       Padding="0,6,0,10"
                                                       HeightRequest="44"
                                                       MinimumHeightRequest="44"
                                                       VerticalOptions="Center">
                                        <Switch IsToggled="{Binding IsSelected, Mode=TwoWay}"
                                            WidthRequest="52"
                                            HeightRequest="32"
                                            MinimumHeightRequest="32"
                                            HorizontalOptions="Start"
                                            VerticalOptions="Center" />
                                        <Label Text="Select for connection"
                                           VerticalOptions="Center"
                                           FontSize="14"
                                           TextColor="Black" />
                                    </HorizontalStackLayout>

                                    <!-- Visual separator before sensor configuration -->
                                    <BoxView HeightRequest="1"
                                         BackgroundColor="LightGray"
                                         Margin="0,20,0,0" />

                                    <!-- Sensor configuration section title -->
                                    <Label Text="Sensor Configuration"
                                       FontAttributes="Bold"
                                       FontSize="14"
                                       TextColor="Black" />

                                    <!-- Grid of sensor toggles. Left column: label; right column: switch bound to VM flags. -->
                                    <Grid ColumnDefinitions="*,Auto"
                                      RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                                      RowSpacing="8">

                                        <Label Grid.Row="0" Grid.Column="0" Text="Low-Noise Accelerometer" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="0" Grid.Column="1" IsToggled="{Binding EnableLowNoiseAccelerometer, Mode=TwoWay}" />

                                        <Label Grid.Row="1" Grid.Column="0" Text="Wide-Range Accelerometer" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="1" Grid.Column="1" IsToggled="{Binding EnableWideRangeAccelerometer, Mode=TwoWay}" />

                                        <Label Grid.Row="2" Grid.Column="0" Text="Gyroscope" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="2" Grid.Column="1" IsToggled="{Binding EnableGyroscope, Mode=TwoWay}" />

                                        <Label Grid.Row="3" Grid.Column="0" Text="Magnetometer" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="3" Grid.Column="1" IsToggled="{Binding EnableMagnetometer, Mode=TwoWay}" />

                                        <Label Grid.Row="4" Grid.Column="0" Text="Pressure &amp; Temperature" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="4" Grid.Column="1" IsToggled="{Binding EnablePressureTemperature, Mode=TwoWay}" />

                                        <Label Grid.Row="5" Grid.Column="0" Text="Battery Voltage" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="5" Grid.Column="1" IsToggled="{Binding EnableBattery, Mode=TwoWay}" />

                                        <Label Grid.Row="6" Grid.Column="0" Text="External ADC A6" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="6" Grid.Column="1" IsToggled="{Binding EnableExtA6, Mode=TwoWay}" />

                                        <Label Grid.Row="7" Grid.Column="0" Text="External ADC A7" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="7" Grid.Column="1" IsToggled="{Binding EnableExtA7, Mode=TwoWay}" />

                                        <Label Grid.Row="8" Grid.Column="0" Text="External ADC A15" VerticalOptions="Center" TextColor="Black" />
                                        <Switch Grid.Row="8" Grid.Column="1" IsToggled="{Binding EnableExtA15, Mode=TwoWay}" />

                                        <!-- EXG-specific radio group (visible only when IsExg is true in the item VM) -->
                                        <Label Grid.Row="9" Grid.Column="0"
                                           Text="ECG/EMG"
                                           VerticalOptions="Start"
                                           TextColor="Black"
                                           IsVisible="{Binding IsExg}"
                                           Margin="0,12,0,0" />

                                        <!-- Mutually exclusive EXG modes via radio buttons; styled with the custom control template -->
                                        <VerticalStackLayout Grid.Row="9" Grid.Column="1"
                                                         Spacing="6"
                                                         IsVisible="{Binding IsExg}"
                                                         Margin="0,12,0,0">
                                            <RadioButton Content="ECG"
                                                 TextColor="Black"
                                                 ControlTemplate="{StaticResource RadioWithDotTemplate}"
                                                 GroupName="{Binding ExgModeGroupName}"
                                                 IsChecked="{Binding IsExgModeECG, Mode=TwoWay}" />

                                            <RadioButton Content="EMG"
                                                 TextColor="Black"
                                                 ControlTemplate="{StaticResource RadioWithDotTemplate}"
                                                 GroupName="{Binding ExgModeGroupName}"
                                                 IsChecked="{Binding IsExgModeEMG, Mode=TwoWay}" />

                                            <RadioButton Content="EXG Test"
                                                 TextColor="Black"
                                                 ControlTemplate="{StaticResource RadioWithDotTemplate}"
                                                 GroupName="{Binding ExgModeGroupName}"
                                                 IsChecked="{Binding IsExgModeTest, Mode=TwoWay}" />

                                            <RadioButton Content="Respiration"
                                                 TextColor="Black"
                                                 ControlTemplate="{StaticResource RadioWithDotTemplate}"
                                                 GroupName="{Binding ExgModeGroupName}"
                                                 IsChecked="{Binding IsExgModeRespiration, Mode=TwoWay}" />

                                        </VerticalStackLayout>
                                    </Grid>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

     <!-- Main action to connect to all devices the user toggled on (IsSelected = true). -->
    <Button Text="Connect to Selected Devices"
        Style="{StaticResource PrimaryButton}"
        Command="{Binding ConnectCommand}"
        CommandParameter="{Binding Navigation, Source={x:Reference MainPageRoot}}">
                    <Button.Triggers>

                        <!-- Disable connect while refreshing to avoid conflicting operations -->
                        <DataTrigger TargetType="Button" Binding="{Binding IsRefreshing}" Value="True">
                            <Setter Property="IsEnabled" Value="False" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

            </VerticalStackLayout>
        </ScrollView>

    <!-- Fullscreen overlay shown during refresh operations.
            Blocks input and provides progress feedback (spinner + message). -->
        <Grid IsVisible="{Binding IsRefreshing}"
      BackgroundColor="#88000000"
      InputTransparent="False">
            <Frame Padding="20"
                     CornerRadius="14"
                     BackgroundColor="White"
                     HasShadow="True"
                     HorizontalOptions="Center"
                     VerticalOptions="Center">
                <VerticalStackLayout Spacing="12" HorizontalOptions="Center">
                    <ActivityIndicator IsRunning="{Binding IsRefreshing}" WidthRequest="36" HeightRequest="36" />
                    <Label Text="{Binding OverlayMessage}"
                       FontAttributes="Bold"
                       FontSize="16"
                       TextColor="Black"
                       HorizontalTextAlignment="Center" />
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>

